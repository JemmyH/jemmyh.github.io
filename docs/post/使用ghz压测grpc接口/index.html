<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>使用ghz压测GRPC接口 - Jemmy&#39;s blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="JemmyHu(hujm20151021@gmail.com)" /><meta name="description" content="一、前言 公司后端服务已经全部微服务化，想要调试某个服务可以使用 grpcui，但要对某个接口进行压测，grpcui 还做不到。诸多努力之后找到本" /><meta name="keywords" content="Jemmy, blog" />






<meta name="generator" content="Hugo 0.76.5 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/%E4%BD%BF%E7%94%A8ghz%E5%8E%8B%E6%B5%8Bgrpc%E6%8E%A5%E5%8F%A3/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c7bc1becf36bcf6a9ebd25d2947e43a2eb745ddb0c9a32b43126fd7fa460c351.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="使用ghz压测GRPC接口" />
<meta property="og:description" content="一、前言 公司后端服务已经全部微服务化，想要调试某个服务可以使用 grpcui，但要对某个接口进行压测，grpcui 还做不到。诸多努力之后找到本" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/%E4%BD%BF%E7%94%A8ghz%E5%8E%8B%E6%B5%8Bgrpc%E6%8E%A5%E5%8F%A3/" />
<meta property="article:published_time" content="2020-11-09T19:35:34+08:00" />
<meta property="article:modified_time" content="2020-11-09T19:35:34+08:00" />
<meta itemprop="name" content="使用ghz压测GRPC接口">
<meta itemprop="description" content="一、前言 公司后端服务已经全部微服务化，想要调试某个服务可以使用 grpcui，但要对某个接口进行压测，grpcui 还做不到。诸多努力之后找到本">
<meta itemprop="datePublished" content="2020-11-09T19:35:34+08:00" />
<meta itemprop="dateModified" content="2020-11-09T19:35:34+08:00" />
<meta itemprop="wordCount" content="2353">



<meta itemprop="keywords" content="效率,ghz,压测GRPC接口," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用ghz压测GRPC接口"/>
<meta name="twitter:description" content="一、前言 公司后端服务已经全部微服务化，想要调试某个服务可以使用 grpcui，但要对某个接口进行压测，grpcui 还做不到。诸多努力之后找到本"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Jemmy&#39;s blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">时间线</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Jemmy&#39;s blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">时间线</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">使用ghz压测GRPC接口</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-11-09 19:35 </span>
        <div class="post-category">
            <a href="/categories/%E6%8A%80%E6%9C%AF%E5%8D%9A%E5%AE%A2/"> 技术博客 </a>
            <a href="/categories/%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82/"> 技术细节 </a>
            <a href="/categories/%E6%95%88%E7%8E%87%E4%B8%8E%E5%B7%A5%E5%85%B7/"> 效率与工具 </a>
            </div>
          <span class="more-meta"> 约 2353 字 </span>
          <span class="more-meta"> 预计阅读 5 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#一前言">一、前言</a></li>
        <li><a href="#二使用">二、使用</a>
          <ul>
            <li><a href="#1-安装">1. 安装</a></li>
            <li><a href="#2-生成-protoset-文件">2. 生成 <code>protoset</code> 文件</a></li>
            <li><a href="#3-执行压测任务">3. 执行压测任务</a></li>
          </ul>
        </li>
        <li><a href="#三参考资料">三、参考资料</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="一前言">一、前言</h2>
<p>公司后端服务已经全部微服务化，想要调试某个服务可以使用 <a href="https://github.com/fullstorydev/grpcui"><code>grpcui</code></a>，但要对某个接口进行压测，<code>grpcui</code> 还做不到。诸多努力之后找到本次主角：<a href="https://github.com/bojand/ghz">https://github.com/bojand/ghz</a>，官网：<a href="https://ghz.sh">ghz.sh</a>。</p>
<p>推荐理由：简洁！可以一次性解决掉 <code>proto</code> 文件相互之间引用的烦心事！</p>
<h2 id="二使用">二、使用</h2>
<blockquote>
<p>这里只介绍在 <code>Mac</code> 环境下的用法，其他环境请参阅官网。</p>
<p>另：我们仍旧使用 <code>GOPATH</code> 方式来管理包，我的： <code>export GOPATH=/Users/hujiaming/go </code>，本次测试目录为：<code>/Users/hujiaming/go/src/hujm.net</code>。</p>
</blockquote>
<h3 id="1-安装">1. 安装</h3>
<p>直接使用 <code>brew</code> 来安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bas" data-lang="bas"><span class="vg">brew</span><span class="w"> </span><span class="vg">install</span><span class="w"> </span><span class="vg">ghz</span>
</code></pre></td></tr></table>
</div>
</div><p>如果不成功，可以直接去 <a href="https://github.com/bojand/ghz/releases">https://github.com/bojand/ghz/releases</a> 下载二进制，下载后放在 <code>PATH</code> 中即可。</p>
<p><strong>注：还需要有 <code>protoc</code> 工具。</strong></p>
<h3 id="2-生成-protoset-文件">2. 生成 <code>protoset</code> 文件</h3>
<p>如果你的 <code>proto</code> 文件中还引用了其他文件，强烈建议使用 <code>protoset</code> 方式。</p>
<p>假如我在如下的 <code>proto</code> 中定义一个 <code>GRPC服务</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="cm">/**
</span><span class="cm"> * @filename: api.proto
</span><span class="cm"> */</span><span class="err">
</span><span class="err"></span><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;github.com/mwitkow/go-proto-validators/validator.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;xxx/mms2/utils/i18n/moneypb/money.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;xxx/cm/fulfillment/offermanager/offerpb/offer.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;xxx/cm/fulfillment/offermanager/offerpb/association.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;xxx/cm/fulfillment/offermanager/offerpb/supplier.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;xxx/cm/core/price/pricepb/price.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kn">package</span> <span class="nn">offerpb</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">service</span> <span class="n">ApiService</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>	<span class="k">rpc</span> <span class="n">CreateSKUAssociations</span><span class="p">(</span><span class="n">CreateSKUAssociationsReq</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">CreateSKUAssociationsReply</span><span class="p">)</span> <span class="p">{};</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">CreateSKUAssociationsReq</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">repeated</span> <span class="n">Association</span> <span class="n">associations</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span> <span class="p">(</span><span class="n">validator.field</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">repeated_count_min</span> <span class="o">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">];</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">CreateSKUAssociationsReply</span> <span class="p">{}</span><span class="err">
</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>而 <code>Association</code> 是定义在 <code>&quot;xxx/cm/fulfillment/offermanager/offerpb/association.proto”</code> 文件中的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="cm">/**
</span><span class="cm"> * @filename: association.proto
</span><span class="cm"> */</span><span class="err">
</span><span class="err"></span><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;github.com/mwitkow/go-proto-validators/validator.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;xxx/mms2/utils/i18n/moneypb/money.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;xxx/cm/fulfillment/offermanager/offerpb/supplier.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;xxx/cm/core/price/pricepb/price.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kn">package</span> <span class="nn">offerpb</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Association</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">int64</span> <span class="n">offer_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span> <span class="p">(</span><span class="n">validator.field</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">int_gt</span> <span class="o">:</span> <span class="mi">1000000000</span><span class="p">}</span> <span class="p">];</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">sku_code</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">[</span> <span class="p">(</span><span class="n">validator.field</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">string_not_empty</span> <span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">];</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">author</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">[</span> <span class="p">(</span><span class="n">validator.field</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">string_not_empty</span> <span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">];</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>如果采用非 <code>protoset</code> 方式，可能要先生成 <code>association.pb.go</code>，再生成 <code>api.pb.go</code> 文件。这里我们采用 <code>protoset</code> 方式，一步到位：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">protoc <span class="se">\ </span>
--include_imports <span class="se">\
</span><span class="se"></span>-I. -I/usr/local/include <span class="se">\
</span><span class="se"></span>-I/usr/local/go <span class="se">\ </span>
-I<span class="nv">$GOPATH</span>/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis <span class="se">\ </span>
-I<span class="nv">$GOPATH</span>/src <span class="se">\
</span><span class="se"></span>--proto_path<span class="o">=</span>. <span class="se">\ </span>
--descriptor_set_out<span class="o">=</span>api.bundle.protoset <span class="se">\ </span>
api.proto
</code></pre></td></tr></table>
</div>
</div><p>需要注意的点如下：</p>
<ol>
<li>如果你的 <code>proto</code> 文件中有引用，上述命令中一定要有 <code>include_imports</code> 参数；</li>
<li>在后面运行时如果出现 <code>no descriptor found for &quot;xxxxxx&quot;</code>，可能是某个文件没有通过 <code>-I</code> 引用进来，记得加上重新执行。</li>
</ol>
<p>不出意外，会在当前目录下生成 <code>api.bundle.protoset</code> 文件。</p>
<h3 id="3-执行压测任务">3. 执行压测任务</h3>
<p>可以看一下 <code>ghz</code> 的用法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">$ ghz --help
usage: ghz <span class="o">[</span>&lt;flags&gt;<span class="o">]</span> <span class="o">[</span>&lt;host&gt;<span class="o">]</span>

Flags:
  -h, --help                   Show context-sensitive <span class="nb">help</span> <span class="o">(</span>also try --help-long and --help-man<span class="o">)</span>.
      --config<span class="o">=</span>                Path to the JSON or TOML config file that specifies all the <span class="nb">test</span> run settings.
      --proto<span class="o">=</span>                 The Protocol Buffer .proto file.
      --protoset<span class="o">=</span>              The compiled protoset file. Alternative to proto. -proto takes precedence.
      --call<span class="o">=</span>                  A fully-qualified method name in <span class="s1">&#39;package.Service/method&#39;</span> or <span class="s1">&#39;package.Service.Method&#39;</span> format.
  -i, --import-paths<span class="o">=</span>          Comma separated list of proto import paths. The current working directory and the directory of the protocol buffer file are automatically added to the import list.
      --cacert<span class="o">=</span>                File containing trusted root certificates <span class="k">for</span> verifying the server.
      --cert<span class="o">=</span>                  File containing client certificate <span class="o">(</span>public key<span class="o">)</span>, to present to the server. Must also provide -key option.
      --key<span class="o">=</span>                   File containing client private key, to present to the server. Must also provide -cert option.
      --cname<span class="o">=</span>                 Server name override when validating TLS certificate - useful <span class="k">for</span> self signed certs.
      --skipTLS                Skip TLS client verification of the server<span class="s1">&#39;s certificate chain and host name.
</span><span class="s1">      --skipFirst=0            Skip the first X requests when doing the results tally.
</span><span class="s1">      --insecure               Use plaintext and insecure connection.
</span><span class="s1">      --authority=             Value to be used as the :authority pseudo-header. Only works if -insecure is used.
</span><span class="s1">  -c, --concurrency=50         Number of requests to run concurrently. Total number of requests cannot be smaller than the concurrency level. Default is 50.
</span><span class="s1">  -n, --total=200              Number of requests to run. Default is 200.
</span><span class="s1">  -q, --qps=0                  Rate limit, in queries per second (QPS). Default is no rate limit.
</span><span class="s1">  -t, --timeout=20s            Timeout for each request. Default is 20s, use 0 for infinite.
</span><span class="s1">  -z, --duration=0             Duration of application to send requests. When duration is reached, application stops and exits. If duration is specified, n is ignored. Examples: -z 10s -z 3m.
</span><span class="s1">  -x, --max-duration=0         Maximum duration of application to send requests with n setting respected. If duration is reached before n requests are completed, application stops and exits. Examples: -x
</span><span class="s1">                               10s -x 3m.
</span><span class="s1">      --duration-stop=&#34;close&#34;  Specifies how duration stop is reported. Options are close, wait or ignore.
</span><span class="s1">  -d, --data=                  The call data as stringified JSON. If the value is &#39;</span>@<span class="err">&#39;</span> <span class="k">then</span> the request contents are <span class="nb">read</span> from stdin.
  -D, --data-file<span class="o">=</span>             File path <span class="k">for</span> call data JSON file. Examples: /home/user/file.json or ./file.json.
  -b, --binary                 The call data comes as serialized binary message or multiple count-prefixed messages <span class="nb">read</span> from stdin.
  -B, --binary-file<span class="o">=</span>           File path <span class="k">for</span> the call data as serialized binary message or multiple count-prefixed messages.
  -m, --metadata<span class="o">=</span>              Request metadata as stringified JSON.
  -M, --metadata-file<span class="o">=</span>         File path <span class="k">for</span> call metadata JSON file. Examples: /home/user/metadata.json or ./metadata.json.
      --stream-interval<span class="o">=</span><span class="m">0</span>      Interval <span class="k">for</span> stream requests between message sends.
      --reflect-metadata<span class="o">=</span>      Reflect metadata as stringified JSON used only <span class="k">for</span> reflection request.
  -o, --output<span class="o">=</span>                Output path. If none provided stdout is used.
  -O, --format<span class="o">=</span>                Output format. One of: summary, csv, json, pretty, html, influx-summary, influx-details. Default is summary.
      --connections<span class="o">=</span><span class="m">1</span>          Number of connections to use. Concurrency is distributed evenly among all the connections. Default is 1.
      --connect-timeout<span class="o">=</span>10s    Connection timeout <span class="k">for</span> the initial connection dial. Default is 10s.
      --keepalive<span class="o">=</span><span class="m">0</span>            Keepalive <span class="nb">time</span> duration. Only used <span class="k">if</span> present and above 0.
      --name<span class="o">=</span>                  User specified name <span class="k">for</span> the test.
      --tags<span class="o">=</span>                  JSON representation of user-defined string tags.
      --cpus<span class="o">=</span><span class="m">8</span>                 Number of cpu cores to use.
      --debug<span class="o">=</span>                 The path to debug log file.
  -e, --enable-compression     Enable Gzip compression on requests.
  -v, --version                Show application version.

Args:
  <span class="o">[</span>&lt;host&gt;<span class="o">]</span>  Host and port to test.
</code></pre></td></tr></table>
</div>
</div><p>需要关注的几个参数：</p>
<ul>
<li>
<p><code>--skipTLS --insecure</code>：如果服务不支持 <code>HTTPS</code> 的话，可以使用此参数跳过 <code>TLS</code> 验证；</p>
</li>
<li>
<p><code>--protoset</code>：指定本次运行的 <code>protoset</code> 文件路径，即上面生成的 <code>api.bundle.protoset</code>；</p>
</li>
<li>
<p><code>--call</code>：需要调用的方法名，格式为：<code>包名.服务名.方法名</code>。比如我要调用 <code>offerpb</code> 包下的 <code>ApiService</code> 服务的 <code>CreateSKUAssociations</code> 方法，那么 <code>call</code> 参数应该是： <code>--call offerpb.ApiService.CreateSKUAssociations</code>；</p>
</li>
<li>
<p><code>--data</code>：本次请求的参数，通过 <code>jsonString</code> 的格式传入；</p>
</li>
<li>
<p><code>--data-file</code>：本次请求的参数，只不过通过文件的形式传入，文件中是标准的通过 <code>json</code> 序列化后的数据；</p>
</li>
<li>
<p><code>--metadata</code>：<code>metadata</code> 参数，通过 <code>jsonString</code> 的格式传入；</p>
</li>
<li>
<p><code>-c</code>：并发数，默认 50(这里有坑，具体参照官网解释：<a href="https://ghz.sh/docs/options#-c---concurrency">-c</a>。虽然会其多个 <code>goroutine</code>，但是所有的 <code>goroutine</code> 会公用一个连接)；</p>
</li>
<li>
<p><code>-n</code>：请求数，默认 200。<code>n</code> 不能小于 <code>c</code>。</p>
</li>
</ul>
<p>假设 <code>ApiService</code>服务的地址是：<code>localhost:58784</code>。我们执行下面的命令，发起一次压测任务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">$ ghz <span class="se">\
</span><span class="se"></span>--skipTLS --insecure --protoset /Users/hujiaming/go/src/hujm.net/api.bundle.protoset <span class="se">\
</span><span class="se"></span>--call offerpb.ApiService.CreateSKUAssociations <span class="se">\
</span><span class="se"></span>--data <span class="s1">&#39;{&#34;associations&#34;:[{&#34;sku_code&#34;: &#34;test:6985079117562211244&#34;,&#34;offer_id&#34;: 8629237865019910744,&#34;author&#34;: &#34;test_by_ghz&#34;}]}&#39;</span> <span class="se">\
</span><span class="se"></span>-m <span class="s1">&#39;{&#34;name&#34;: &#34;test&#34;}&#39;</span> <span class="se">\
</span><span class="se"></span>-c <span class="m">100</span> -n <span class="m">1000</span> <span class="se">\
</span><span class="se"></span>localhost:58784 
</code></pre></td></tr></table>
</div>
</div><p>当你的请求参数比较多时，将他们放在一个文件中、然后使用 <code>--data-file</code> 参数是更好的选择：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">$ cat test_data.json
<span class="o">{</span>
  <span class="s2">&#34;associations&#34;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&#34;sku_code&#34;</span>: <span class="s2">&#34;test:6237052533738512496&#34;</span>,
      <span class="s2">&#34;offer_id&#34;</span>: 5655307241153104444,
      <span class="s2">&#34;author&#34;</span>: <span class="s2">&#34;test_by_ghz&#34;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&#34;sku_code&#34;</span>: <span class="s2">&#34;test:2156276639623439583&#34;</span>,
      <span class="s2">&#34;offer_id&#34;</span>: 6360134836979240095,
      <span class="s2">&#34;author&#34;</span>: <span class="s2">&#34;test_by_ghz&#34;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&#34;sku_code&#34;</span>: <span class="s2">&#34;test:8361104385030719827&#34;</span>,
      <span class="s2">&#34;offer_id&#34;</span>: 3705044490439993926,
      <span class="s2">&#34;author&#34;</span>: <span class="s2">&#34;test_by_ghz&#34;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&#34;sku_code&#34;</span>: <span class="s2">&#34;test:6023087259299523902&#34;</span>,
      <span class="s2">&#34;offer_id&#34;</span>: 3776027093787512475,
      <span class="s2">&#34;author&#34;</span>: <span class="s2">&#34;test_by_ghz&#34;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&#34;sku_code&#34;</span>: <span class="s2">&#34;test:9196748606623463644&#34;</span>,
      <span class="s2">&#34;offer_id&#34;</span>: 1506864634761125694,
      <span class="s2">&#34;author&#34;</span>: <span class="s2">&#34;test_by_ghz&#34;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>

$ ghz <span class="se">\
</span><span class="se"></span>--skipTLS --insecure --protoset /Users/hujiaming/go/src/hujm.net/api.bundle.protoset <span class="se">\
</span><span class="se"></span>--call offerpb.ApiService.CreateSKUAssociations <span class="se">\
</span><span class="se"></span>--data-file /Users/hujiaming/go/src/hujm.net/test_data.json <span class="se">\
</span><span class="se"></span>-m <span class="s1">&#39;{&#34;name&#34;: &#34;test&#34;}&#39;</span> <span class="se">\
</span><span class="se"></span>-c <span class="m">100</span> -n <span class="m">1000</span> <span class="se">\
</span><span class="se"></span>localhost:58784 
</code></pre></td></tr></table>
</div>
</div><p>看下输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">Summary:
  Count:	<span class="m">1000</span>
  Total:	743.17 ms
  Slowest:	194.74 ms
  Fastest:	37.67 ms
  Average:	69.32 ms
  Requests/sec:	1345.59

Response <span class="nb">time</span> histogram:
  37.670 <span class="o">[</span>1<span class="o">]</span>	<span class="p">|</span>
  53.377 <span class="o">[</span>384<span class="o">]</span>	<span class="p">|</span>∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎
  69.084 <span class="o">[</span>349<span class="o">]</span>	<span class="p">|</span>∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎
  84.791 <span class="o">[</span>138<span class="o">]</span>	<span class="p">|</span>∎∎∎∎∎∎∎∎∎∎∎∎∎∎
  100.498 <span class="o">[</span>26<span class="o">]</span>	<span class="p">|</span>∎∎∎
  116.205 <span class="o">[</span>2<span class="o">]</span>	<span class="p">|</span>
  131.912 <span class="o">[</span>0<span class="o">]</span>	<span class="p">|</span>
  147.619 <span class="o">[</span>16<span class="o">]</span>	<span class="p">|</span>∎∎
  163.326 <span class="o">[</span>33<span class="o">]</span>	<span class="p">|</span>∎∎∎
  179.033 <span class="o">[</span>17<span class="o">]</span>	<span class="p">|</span>∎∎
  194.739 <span class="o">[</span>34<span class="o">]</span>	<span class="p">|</span>∎∎∎∎

Latency distribution:
  <span class="m">10</span> % in 46.59 ms
  <span class="m">25</span> % in 49.94 ms
  <span class="m">50</span> % in 57.28 ms
  <span class="m">75</span> % in 69.51 ms
  <span class="m">90</span> % in 102.33 ms
  <span class="m">95</span> % in 163.38 ms
  <span class="m">99</span> % in 183.99 ms

Status code distribution:
  <span class="o">[</span>OK<span class="o">]</span>   <span class="m">1000</span> responses
</code></pre></td></tr></table>
</div>
</div><p><code>Summary</code> 的参数：</p>
<ul>
<li><code>Count</code>：完成的请求总数，包括成功的和失败的；</li>
<li><code>Total</code>：本次请求所用的总时长，从 <code>ghz</code> 启动一直到结束；</li>
<li><code>Slowest</code>：最慢的某次请求的时间；</li>
<li><code>Fastest</code>：最快的某个请求的时间；</li>
<li><code>Average</code>：<code>(所有请求的响应时间) / Count</code>。</li>
<li><code>Requests/sec</code>：<code>RTS</code>，<code>Count / Total</code> 的值。</li>
</ul>
<h2 id="三参考资料">三、参考资料</h2>
<ul>
<li><a href="https://github.com/bojand/ghz">https://github.com/bojand/ghz</a></li>
<li><a href="https://ghz.sh/">Simple gRPC benchmarking and load testing tool</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">JemmyHu(hujm20151021@gmail.com)</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-11-09 19:35
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%95%88%E7%8E%87/">效率</a>
          <a href="/tags/ghz/">ghz</a>
          <a href="/tags/%E5%8E%8B%E6%B5%8Bgrpc%E6%8E%A5%E5%8F%A3/">压测GRPC接口</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/%E4%BC%98%E7%A7%80%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E9%BB%98%E5%85%8B%E5%B0%94%E6%A0%91/">
            <span class="next-text nav-default">优秀数据结构--默克尔树</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'LjkR3NaCog7bTVOnJNMmJjcM-gzGzoHsz',
        appKey: 'UQMdKbH71EeHJppAbtDwb5Rg',
        notify:  true ,
        verify:  false ,
        avatar:'monsterid',
        placeholder: '欢迎留言~',
        visitor:  false 
    });
  </script>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:hujm20151021@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/JemmyH" class="iconfont icon-github" title="github"></a>
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2020<span class="heart"><i class="iconfont icon-heart"></i></span><span>Jemmy</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script><script></script><script src="https://cdn.jsdelivr.net/npm/raphael@2.2.7/raphael.min.js" integrity="sha256-67By+NpOtm9ka1R6xpUefeGOY8kWWHHRAKlvaTJ7ONI=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/flowchart.js@1.8.0/release/flowchart.min.js" integrity="sha256-zNGWjubXoY6rb5MnmpBNefO0RgoVYfle9p0tvOQM+6k=" crossorigin="anonymous"></script><script></script><script src="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js" integrity="sha256-4O4pS1SH31ZqrSO2A/2QJTVjTPqVe+jnYgOWUVr7EEc=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/snapsvg@0.5.1/dist/snap.svg-min.js" integrity="sha256-oI+elz+sIm+jpn8F/qEspKoKveTc5uKeFHNNVexe6d8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/underscore@1.8.3/underscore-min.js" integrity="sha256-obZACiHd7gkOk9iIL/pimWMTJ4W/pBsKu+oZnSeBIek=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.js" integrity="sha384-8748Vn52gHJYJI0XEuPB2QlPVNUkJlJn9tHqKec6J3q2r9l8fvRxrgn/E5ZHV0sP" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bramp/js-sequence-diagrams@2.0.1/dist/sequence-diagram-min.css" integrity="sha384-6QbLKJMz5dS3adWSeINZe74uSydBGFbnzaAYmp+tKyq60S7H2p6V7g1TysM5lAaF" crossorigin="anonymous">



<script type="text/javascript" src="/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
